

<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Skipper Seabold, a well known contributor to the PyData community, recently gave a <a href="https://youtu.be/kTo16ieMCi8">talk</a> titled “What’s the Science in Data Science?”. His talk presents several methods commonly used in econometrics that could benefit the field of data science if more widely adopted. Some of the methods were:</p>
<ul>
<li>Instrumental Variables</li>
<li>Matching</li>
<li>Difference-in-Differences</li>
</ul>
<p>From what I gather, these modeling techniques are popular for discovering causal relationships in observational studies. When an RCT (randomized control trial) is unreasonable then these techniques give us an alternative approach.</p>
<p>I’ll be exploring one of these methods called <em>Instrumental Variables</em> (or IV). An example use case from Skipper’s talk was a <a href="https://www.aeaweb.org/articles?id=10.1257/jep.20.2.207">study</a> on the <strong>Fulton Fish Market</strong> in NYC.</p>
<p><img src="/post/2019-03-26-market-price-with-instrumental-variables_files/fulton.jpg" alt="drawing" width="50%"/></p>
<p>The referenced study estimates the demand curve for fish at the market. Finding the demand curve is unfortunately not as simple as regressing quantity on price. The relationship between price and the quantity of fish sold is not exclusive to demand but includes supply effects at the market. We’ll be using IV to account for supply effects to isolate the demand effects.</p>
<p>In this blog post I’ll be reproducing a portion of this analysis using R, packages of the <a href="https://www.tidyverse.org/">tidyverse</a>, and the <a href="https://github.com/paul-buerkner/brms">brms</a> package in R.</p>
</div>
<div id="data" class="section level2">
<h2>Data</h2>
<p>I discovered data related to this study at the following website:
<a href="http://people.brandeis.edu/~kgraddy/data.html" class="uri">http://people.brandeis.edu/~kgraddy/data.html</a></p>
<p>Bringing this data into R is very simple. The linked dataset appears to be the cleaned and transformed data used within the paper. Let’s read it into our R environment and take a look:</p>
<pre class="r"><code>library(tidyverse)
fulton &lt;- read_tsv(&quot;http://people.brandeis.edu/~kgraddy/datasets/fish.out&quot;)
fulton</code></pre>
<pre><code>## # A tibble: 111 x 16
##     day1  day2  day3  day4   date stormy mixed   price   qty rainy  cold
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     1     0     0     0 911202      1     0 -0.431   8.99     1     0
##  2     0     1     0     0 911203      1     0  0       7.71     0     0
##  3     0     0     1     0 911204      0     1  0.0723  8.35     1     1
##  4     0     0     0     1 911205      1     0  0.247   8.66     0     1
##  5     0     0     0     0 911206      1     0  0.664   7.84     0     1
##  6     1     0     0     0 911209      0     0 -0.207   9.30     0     0
##  7     0     1     0     0 911210      0     1 -0.116   8.92     0     0
##  8     0     0     1     0 911211      0     0 -0.260   9.11     1     0
##  9     0     0     0     1 911212      0     1 -0.117   8.31     0     0
## 10     0     0     0     0 911213      0     0 -0.342   9.21     0     0
## # ... with 101 more rows, and 5 more variables: windspd &lt;dbl&gt;,
## #   windspd2 &lt;dbl&gt;, pricelevel &lt;dbl&gt;, totr &lt;dbl&gt;, tots &lt;dbl&gt;</code></pre>
<p>Here is a quick description of the variables we will be using for this work:</p>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th>Units</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>qty</td>
<td>log(pounds)</td>
<td>The total amount of fish sold on a day</td>
</tr>
<tr class="even">
<td>price</td>
<td>log($/lb)</td>
<td>Average price for the day</td>
</tr>
<tr class="odd">
<td>day1-day4</td>
<td>dummy var</td>
<td>Monday-Thurs</td>
</tr>
<tr class="even">
<td>cold</td>
<td>dummy var</td>
<td>Weather on shore</td>
</tr>
<tr class="odd">
<td>rainy</td>
<td>dummy var</td>
<td>Rain on shore</td>
</tr>
<tr class="even">
<td>stormy</td>
<td>dummy var</td>
<td>Wind and waves off shore (a 3-day moving average)</td>
</tr>
</tbody>
</table>
<p>The paper informs the reader that transactions recorded are of a particular fish species called Whiting. We can get a feel for the total amount of Whiting being sold by reproducing Figure <code>2</code> from the paper.</p>
<pre class="r"><code># fixing the date column 
fulton %&gt;% 
  mutate(
    date = as.character(date),
    date = parse_date(date, format = &quot;%y%m%d&quot;)
  ) %&gt;% 
  ggplot(aes(x = date, y = exp(qty))) +
    geom_col() +
    labs(
      title = &quot;Figure 2&quot;,
      subtitle = &quot;Daily Volumes of Whiting&quot;,
      x = &quot;Date (December 2, 1991-May 8, 1992)&quot;,
      y = &quot;Quantity (pounds)&quot;
      )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-2-1.svg" width="672" /></p>
<p>Reproducing this figure gave me confidence that I had the correct data to reproduce the analysis.</p>
</div>
<div id="demand-curve" class="section level2">
<h2>Demand Curve</h2>
<p>The naive approach to finding the relationship between price and demand (the demand curve) would be to regress quantity on price:</p>
<pre class="r"><code>ggplot(fulton, aes(x = price, y = qty)) + 
  geom_point() + 
  geom_smooth(method = &quot;lm&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-3-1.svg" width="672" /></p>
<p>But would this be the demand curve? No, it actually wouldn’t be. According to intro economics, each one of the points in the plot above is the result of the intersection of both a supply and demand curve. Something like this <a href="https://www.andrewheiss.com/blog/2017/09/15/create-supply-and-demand-economics-curves-with-ggplot2/">figure</a>:</p>
<p><img src="/post/2019-03-26-market-price-with-instrumental-variables_files/supply-demand-intersection-simple-1.png" alt="drawing" width="80%"/></p>
<p>So how does the author go about estimating a more accurate representation of the demand curve? How do you isolate the demand effects from the supply? Well, it’s in the title of this post: <strong>Instrumental Variables</strong>.</p>
<p>Skipper’s presentation explained IV as:</p>
<blockquote>
<p>We can replace <em>X</em> with <strong>“instruments”</strong> that are <strong>correlated with X</strong> but <strong>not caused by Y</strong> or that <strong>affect Y</strong> but <em>only</em> <strong>through X</strong>.
## Regressions</p>
</blockquote>
<p>The paper includes a table of estimated coefficients shown here:</p>
<p><img src="/post/2019-03-26-market-price-with-instrumental-variables_files/table-2.png" alt="drawing" width="80%"/></p>
<p>I’ll be reproducing this table but with Bayesian estimation. A nice benefit of using Bayesian estimation is that our estimated model includes distributions for each of our parameters. We’ll be visualizing these distributions for comparing results to the table above.</p>
<div id="ols-ordinary-least-squares-reproduced" class="section level3">
<h3>OLS (Ordinary Least Squares) Reproduced</h3>
<p>First, let’s perform the classic linear regression. We can use the <code>brm</code> function in the <code>brms</code> package as a drop in replacement for R’s linear model function <code>lm</code>. However, the estimation process of <code>lm</code> and <code>brm</code> are quite different. The <code>lm</code> function is using OLS and the <code>brms</code> package is performing Bayesian estimation using a <a href="https://arxiv.org/abs/1701.02434">form</a> of Markov Chain Monte Carlo (MCMC).</p>
<p>Starting with column <code>1</code> of table <code>2</code> we estimate the coefficients with only <code>qty</code> and <code>price</code>:</p>
<pre class="r"><code>library(brms)
library(tidybayes)
library(ggridges)
# column 1 in table 2
fit1 &lt;- brm(qty ~ price, data = fulton, refresh = 0)
fit1 %&gt;% 
  posterior_samples() %&gt;% 
  ggplot(aes(x = b_price)) +
    geom_density_line()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-4-1.svg" width="672" /></p>
<p>The <code>brms</code> package provides an abstraction layer to the <code>Stan</code> probabilistic programming language. So if you’re curious what the “uninformative” priors that I breezed over actually are, take a look at the generated code with the <code>stancode</code> function. Here is an excerpt of the stan code generated for the model above:</p>
<pre class="stan"><code>model {
  vector[N] mu = temp_Intercept + Xc * b;
  // priors including all constants
  target += student_t_lpdf(temp_Intercept | 3, 9, 10);
  target += student_t_lpdf(sigma | 3, 0, 10)
    - 1 * student_t_lccdf(0 | 3, 0, 10);
  // likelihood including all constants
  if (!prior_only) {
    target += normal_lpdf(Y | mu, sigma);
  }
}</code></pre>
<p>Moving to column <code>2</code> of table <code>2</code> we estimate the model including the dummy <code>day</code> variables, <code>cold</code>, and <code>rainy</code> variables:</p>
<pre class="r"><code># column 2 in table 2
fit1_full &lt;- brm(
  qty ~ price + day1 + day2 + day3 + day4 + cold + rainy,
  data = fulton,
  refresh = 0
)
# a plot of parameter estimates
fit1_full %&gt;% 
  posterior_samples() %&gt;% 
  gather(b_price:b_rainy, key = &quot;coef&quot;, value = &quot;est&quot;) %&gt;% 
  ggplot(aes(x = est, y = coef)) +
    geom_density_ridges()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-6-1.svg" width="672" /></p>
<p>We can see that the estimated coefficient for price in this context is the same for both the simple linear regression and the regression accounting for weekday and onshore weather.</p>
</div>
<div id="iv-reproduced" class="section level3">
<h3>IV Reproduced</h3>
<p>Before performing the estimation I wanted to add a quote from the paper. I thought Kathryn Graddy explained the IV estimation well:</p>
<blockquote>
<p>That is, first a regression is run with log price as the dependent variable and the storminess of the weather as the explanatory variable. This regression seeks to measure the variation in price that is attributable to stormy weather. The coefficients from this regression are then used to predict log price on each day, and these predicted values for price are inserted back into the regression.
Kathryn mentions two steps here:</p>
</blockquote>
<ol style="list-style-type: decimal">
<li>A regression with log price and storminess</li>
<li>Using coefficients from step <code>1</code>, predict log price and place the predicted values back into the second regression.</li>
</ol>
<p>A simple diagram of this two step process is generated below:</p>
<pre class="r"><code>library(ggdag)
dagify(
  qty ~ price, 
  price ~ stormy
  ) %&gt;% 
  ggdag(seed = 12) +
  theme(panel.background = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-7-1.svg" width="672" /></p>
<p>Now let’s perform the estimation. This is possible with the <code>brms</code> package and its ability to specify multivariate response models. We’ll piece it together with two separate formulas defined in the <code>bf</code> function calls below.</p>
<p>The first estimation will be for column <code>3</code> of table <code>2</code>:</p>
<pre class="r"><code># measure variation in price attributable to stormy weather
fit2a &lt;- bf(price ~ stormy)
# estimate demand
fit2b &lt;- bf(qty ~ price)
# column 3 in table 2
fit2 &lt;- brm(fit2a + fit2b, data = fulton, refresh = 0)
fit2 %&gt;% 
  posterior_samples() %&gt;% 
  ggplot(aes(x = b_qty_price)) +
    geom_density_line()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-8-1.svg" width="672" /></p>
<p>And lastly we’ll estimate the IV with the remaining variables (column <code>4</code>):</p>
<pre class="r"><code># visual representation of the estimation
dagify(
  qty ~ price + day1 + day2 + day3 + day4 + cold + rainy, 
  price ~ stormy
  ) %&gt;% 
  ggdag(seed = 9) +
  theme(panel.background = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.svg" width="672" /></p>
<pre class="r"><code># add additional demand specific variables
fit2b_full &lt;- bf(qty ~ price + day1 + day2 + day3 + day4 + cold + rainy)
# column 4 in table 2
fit2_full &lt;- brm(fit2a + fit2b_full, data = fulton, refresh = 0)
fit2_full %&gt;% 
  posterior_samples() %&gt;% 
  gather(b_qty_price:b_qty_rainy, key = &quot;coef&quot;, value = &quot;est&quot;) %&gt;% 
  ggplot(aes(x = est, y = coef)) +
    geom_density_ridges()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-10-1.svg" width="672" /></p>
<p>One thing that I think is particularly interesting about the distributions above is the uncertainty of the price coefficient. We can clearly see that the parameter’s distribution with IV is much wider than our classic linear regression. Here we are seeing the uncertainty of our first model (<code>price ~ storminess</code>) propagating to our second model.</p>
</div>
<div id="visualizing-the-demand-curve" class="section level3">
<h3>Visualizing the Demand Curve</h3>
<p>Now we can plot the demand curve with isolated demand effects. I’ll use the first IV estimation with only <code>qty</code>, <code>price</code>, and <code>stormy</code> variables:</p>
<pre class="r"><code>fulton %&gt;% 
  add_predicted_draws(fit2) %&gt;% 
  filter(.category == &quot;qty&quot;) %&gt;% 
  ggplot(aes(x = price, y = qty)) +
  stat_lineribbon(
    aes(y = .prediction), 
    .width = c(.99, .95, .8, .5), 
    color = &quot;#08519C&quot;
    ) +
  geom_point(data = fulton, size = 2) +
  scale_fill_brewer()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-11-1.svg" width="672" /></p>
<p>The prediction is downward trending as the original curve except with a steeper slope (<code>-0.54</code> vs <code>-1.06</code>).</p>
</div>
</div>
<div id="elasticities" class="section level2">
<h2>Elasticities</h2>
<p>The paper breaks down the interpretation of the estimated coefficients in terms of elasticities. Given that we have taken the <code>log</code> of both our quantity and price the coefficients can be interpreted in a clever way. Let’s take a look at why this is the case:</p>
<p>If we take the log of both <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span> of our linear model:</p>
<p><span class="math display">\[
\text{log}(y) = \beta_0 + \beta_1\text{log}(x) + \epsilon
\]</span>
Now solve for <span class="math inline">\(y\)</span> to find the marginal effects:</p>
<p><span class="math display">\[
y = e^{\beta_o + \beta_1\text{log}(x) + \epsilon}
\]</span>
Then differentiate with respect to <span class="math inline">\(x\)</span>:</p>
<p><span class="math display">\[
\frac{dy}{dx} = \frac{\beta_1}{x}e^{\beta_o + \beta_1\text{log}(x) + \epsilon} = \beta_1 \frac{y}{x}
\]</span></p>
<p>If you then solve for <span class="math inline">\(\beta_1\)</span> you find:</p>
<p><span class="math display">\[
\beta_1 = \frac{dy}{dx} \frac{x}{y}
\]</span>
So here <span class="math inline">\(\beta_1\)</span> is an elasticity. For a <span class="math inline">\(\%\)</span> increase in <span class="math inline">\(x\)</span> there is a <span class="math inline">\(\beta_1 \%\)</span> increase in <span class="math inline">\(y\)</span>.</p>
<p>Elasticities are commonly summarized in a table like this:</p>
<table>
<thead>
<tr class="header">
<th>Elasticity</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Elastic</td>
<td>| <em>E</em> | &gt; 1</td>
<td>% change in <em>Q</em> &gt; % change in <em>P</em></td>
</tr>
<tr class="even">
<td>Unitary Elastic</td>
<td>| <em>E</em> | = 1</td>
<td>% change in <em>Q</em> = %change in <em>P</em></td>
</tr>
<tr class="odd">
<td>Inelastic</td>
<td>| <em>E</em> | &lt; 1</td>
<td>% change in <em>Q</em> &lt; % change in <em>P</em></td>
</tr>
</tbody>
</table>
<p>Given the descriptions of elasticity above. We would have two different interpretations of how demand responds to price with the non-IV and the IV estimation. With the non-IV estimation our elasticity coefficient is <code>-0.54</code> [-0.9, -0.17]. With the IV estimation our elasticity is <code>-1.06</code> [-2.21, -0.14]. So we would mistakenly interpret the demand elasticity as being inelastic when it actually appears to be unit elastic.</p>
<p>Some interesting interpretations of this unit elasticity from the paper include:</p>
<blockquote>
<p>First, it is consistent with pricing power on the part of the
fish dealers. A price-setting firm will raise price to the point where the percentage change in the quantity demanded is at least as large as the percentage change in price; otherwise, it would make sense to raise the price even more
Second, when demand has a unitary elasticity, it means that the percentage change in quantity would always equal the percentage change in price, and the weather would therefore not have much effect on a seller’s revenue, keeping fishermen’s incomes relatively constant.
Third, unit elasticities could also result from budget constraints on the part of some buyers.
## Wrapping Up</p>
</blockquote>
<p>This was definitely a fun topic to start exploring. I plan on taking a look at <em>difference-in-differences</em> in the near future as well.</p>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<ul>
<li><a href="https://youtu.be/kTo16ieMCi8">What’s the Science in Data Science?</a></li>
<li><a href="https://www.aeaweb.org/articles?id=10.1257/jep.20.2.207">Graddy, Kathryn. 2006. “Markets: The Fulton Fish Market.” Journal of Economic Perspectives, 20 (2): 207-220.</a></li>
<li><a href="https://www.andrewheiss.com/blog/2017/09/15/create-supply-and-demand-economics-curves-with-ggplot2/">Create supply and demand economics curves with ggplot2</a></li>
<li><a href="https://arxiv.org/abs/1701.02434">Michael Betancourt: “A Conceptual Introduction to Hamiltonian Monte Carlo”, 2017</a></li>
</ul>
</div>
